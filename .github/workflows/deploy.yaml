name: Deploy to Cloud Run (Keyless WIF)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        token_format: "access_token"
        workload_identity_provider: "projects/382207431122/locations/global/workloadIdentityPools/github-pool-2/providers/github-provider"
        service_account: "github-deploy@kxnwork.iam.gserviceaccount.com"

    - name: Configure gcloud
      uses: google-github-actions/setup-gcloud@v2

    - name: Build and Push to Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev
        gcloud builds submit --tag us-central1-docker.pkg.dev/kxnwork/cloudrun-wif-repo/app

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy cloudrun-wif-demo \
          --image us-central1-docker.pkg.dev/kxnwork/cloudrun-wif-repo/app \
          --region us-central1 \
          --platform managed \
          --allow-unauthenticated
